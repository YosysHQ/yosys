CMAKE_MINIMUM_REQUIRED(VERSION 3.10.3)
PROJECT(yosys)

SET(CMAKE_C_STANDARD 11)
SET(CMAKE_CXX_STANDARD 11)
FIND_PACKAGE(FLEX)
FIND_PACKAGE(BISON)
FIND_PROGRAM(PythonInterpreter python3 python)

OPTION(ENABLE_ABC "Enable use ABC library." ON)

ADD_DEFINITIONS(-D_YOSYS_)
ADD_DEFINITIONS(-DYOSYS_ENABLE_READLINE)
ADD_DEFINITIONS(-DYOSYS_ENABLE_PLUGINS)
ADD_DEFINITIONS(-DYOSYS_ENABLE_GLOB)
ADD_DEFINITIONS(-DYOSYS_ENABLE_TCL)
ADD_DEFINITIONS(-DYOSYS_ENABLE_COVER)
ADD_DEFINITIONS(-DYOSYS_ENABLE_ZLIB)
ADD_DEFINITIONS(-DYOSYS_SRC="${CMAKE_CURRENT_LIST_DIR}/")
ADD_DEFINITIONS(-DYOSYS_DATDIR="/usr/local/share/yosys")

INCLUDE_DIRECTORIES(${CMAKE_CURRENT_LIST_DIR})
INCLUDE_DIRECTORIES(/usr/include/tcl8.6)
ADD_COMPILE_OPTIONS(-Wall -Wextra -ggdb -Os -g -I/usr/include/tcl -MD -fPIC)
ADD_COMPILE_OPTIONS(-Wno-unused-parameter)

IF (${ENABLE_ABC})

    IF (IS_DIRECTORY ${CMAKE_CURRENT_LIST_DIR}/abc)
        IF (EXISTS ${CMAKE_CURRENT_LIST_DIR}/abc/CMakeLists.txt)
            SET(REQUIRE_CLONE_ABC OFF)
        ELSE()
            SET(REQUIRE_CLONE_ABC ON)
        ENDIF()
    ELSE()
        SET(REQUIRE_CLONE_ABC ON)
    ENDIF()

    IF (REQUIRE_CLONE_ABC)
        SET(ABCREV "341db25")
        SET(ABCURL "https://github.com/YosysHQ/abc")
        EXECUTE_PROCESS(
                COMMAND git clone ${ABCURL} ${CMAKE_CURRENT_LIST_DIR}/abc
                WORKING_DIRECTORY ${CMAKE_CURRENT_LIST_DIR}
        )
        EXECUTE_PROCESS(
                COMMAND git checkout ${ABCREV}
                WORKING_DIRECTORY ${CMAKE_CURRENT_LIST_DIR}/abc
        )
    ENDIF()

    ADD_DEFINITIONS(-DABC_USE_LIBSTDCXX=1)
    ADD_DEFINITIONS(-DYOSYS_ENABLE_ABC)
    ADD_SUBDIRECTORY(abc)
ENDIF ()

MACRO(ADD_MODULE ModuleName)
    ADD_SUBDIRECTORY(${ModuleName})
    ConfigSource(${CMAKE_CURRENT_LIST_DIR}/${ModuleName})
ENDMACRO()

ADD_MODULE(kernel)
ADD_MODULE(frontends)
ADD_MODULE(passes)
ADD_MODULE(backends)
ADD_MODULE(techlibs)
ADD_MODULE(libs)

SET(SRC_LIST
        ${FRONTENDS_SRC}
        ${PASSES_SRC}
        ${BACKENDS_SRC}
        ${TECHLIBS_SRC}
        ${LIBS_SRC}
        ${KERNEL_SRC}
        )

ADD_EXECUTABLE(${PROJECT_NAME} ${SRC_LIST})

IF (${ENABLE_ABC})
    TARGET_LINK_LIBRARIES(${PROJECT_NAME} libabc)
ENDIF()

TARGET_LINK_LIBRARIES(${PROJECT_NAME} -lstdc++ -lm -lz -lrt -lreadline -lffi -ldl -ltcl8.6)
